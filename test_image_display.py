#!/usr/bin/env python
"""
Test script to display images from hex data on SSD1309 display
Paste hex data (like C-style array) and it will be displayed
Supports multiple images that cycle in sequence at a configurable rate
"""

from luma.core.interface.serial import i2c
from luma.core.render import canvas
from luma.oled.device import ssd1309
from PIL import Image
import re
import time

def parse_hex_data(text):
    """
    Parse hex data from text (handles C-style array format)
    Returns tuple: (list of integers, width, height)
    Dimensions are extracted from comments if available (e.g., "64x64px")
    """
    # Try to extract dimensions from comments
    width, height = 64, 64  # defaults
    dimension_pattern = r'(\d+)x(\d+)px'
    for line in text.split('\n'):
        match = re.search(dimension_pattern, line, re.IGNORECASE)
        if match:
            width = int(match.group(1))
            height = int(match.group(2))
            print(f"Found dimensions in comment: {width}x{height}px")
            break
    
    # Remove comments (lines starting with //)
    lines = [line for line in text.split('\n') if not line.strip().startswith('//')]
    text = '\n'.join(lines)
    
    # Extract hex values (0x... format)
    hex_pattern = r'0x([0-9a-fA-F]+)'
    matches = re.findall(hex_pattern, text)
    
    # Convert to integers
    data = [int(hex_val, 16) for hex_val in matches]
    
    return data, width, height

def hex_to_image(hex_data, width=64, height=64):
    """
    Convert hex data to PIL Image
    Assumes 1 bit per pixel (monochrome)
    """
    # Calculate expected size
    expected_bytes = (width * height) // 8
    
    if len(hex_data) < expected_bytes:
        print(f"Warning: Expected {expected_bytes} bytes, got {len(hex_data)}")
        # Pad with zeros if needed
        hex_data.extend([0] * (expected_bytes - len(hex_data)))
    elif len(hex_data) > expected_bytes:
        print(f"Warning: Got {len(hex_data)} bytes, expected {expected_bytes}. Truncating.")
        hex_data = hex_data[:expected_bytes]
    
    # Create image in mode '1' (1-bit pixels, black and white)
    img = Image.new('1', (width, height), 0)  # Start with black
    
    # Convert bytes to pixels
    pixel_index = 0
    for byte_val in hex_data:
        # Each byte represents 8 pixels (MSB first for typical bitmap format)
        for bit in range(7, -1, -1):  # Bits 7 down to 0
            if pixel_index >= width * height:
                break
            x = pixel_index % width
            y = pixel_index // width
            # Set pixel to white (1) if bit is set
            if byte_val & (1 << bit):
                img.putpixel((x, y), 1)
            pixel_index += 1
    
    return img

def display_image_on_oled(image, device):
    """
    Display PIL Image on OLED display
    """
    # Resize if needed to fit display (typically 128x64)
    display_width = device.width
    display_height = device.height
    
    img_width, img_height = image.size
    
    # If image is smaller than display, center it on a black background
    # If image is larger, scale it down to fit
    if img_width > display_width or img_height > display_height:
        # Scale down to fit
        scale = min(display_width / img_width, display_height / img_height)
        new_width = int(img_width * scale)
        new_height = int(img_height * scale)
        image = image.resize((new_width, new_height), Image.NEAREST)
        img_width, img_height = image.size
    
    # Create a full-size display image (black background)
    display_image = Image.new('1', (display_width, display_height), 0)
    
    # Center the image
    x_offset = (display_width - img_width) // 2
    y_offset = (display_height - img_height) // 2
    
    # Paste the image onto the display image
    display_image.paste(image, (x_offset, y_offset))
    
    # Display using device.display() method
    device.display(display_image)

def load_hex_data_from_file(filename):
    """Load hex data from a file"""
    try:
        with open(filename, 'r') as f:
            return f.read()
    except Exception as e:
        print(f"Error reading file {filename}: {e}")
        return None

def parse_multiple_images(text_list):
    """
    Parse multiple hex data blocks into a list of images
    Each element in text_list should be a hex data string
    Returns list of PIL Images
    """
    images = []
    for i, hex_text in enumerate(text_list):
        if not hex_text or not hex_text.strip():
            continue
        try:
            hex_data, img_width, img_height = parse_hex_data(hex_text)
            img = hex_to_image(hex_data, width=img_width, height=img_height)
            images.append(img)
            print(f"  Image {i+1}: {img_width}x{img_height} pixels")
        except Exception as e:
            print(f"  Warning: Failed to parse image {i+1}: {e}")
            continue
    return images

def split_multiple_images_from_text(text, separator="---IMAGE---"):
    """
    Split a single text block into multiple image blocks
    Uses separator string to delimit images
    Returns list of text blocks
    """
    if separator in text:
        return text.split(separator)
    else:
        # If no separator, treat as single image
        return [text]

def main():
    import sys
    import argparse
    
    parser = argparse.ArgumentParser(description='Display images from hex data on SSD1309 OLED')
    parser.add_argument('file', nargs='?', help='File containing hex data (optional)')
    parser.add_argument('--rate', type=float, default=0.5, 
                       help='Frame rate in seconds per image (default: 0.5)')
    parser.add_argument('--single', action='store_true',
                       help='Display single image only (no animation loop)')
    args = parser.parse_args()
    
    print("Image Display Test for SSD1309")
    print("=" * 40)
    
    # Check if hex data provided as argument (file)
    hex_data_text = None
    
    if args.file:
        print(f"Reading hex data from file: {args.file}")
        hex_data_text = load_hex_data_from_file(args.file)
        if hex_data_text is None:
            print("Failed to read file, using example data")
    else:
        print("No file provided, using example hex data")
        print("(You can provide a file: python test_image_display.py <filename> [--rate 0.5])")
        print("(Or paste hex data into the IMAGES list in the script)")
    
    # Example hex data - can be a single image or list of images
    # For multiple images, add them to the IMAGES list below
    # Each image can be separated by "---IMAGE---" in a single string,
    # or you can use a list of separate hex data strings
    
    # Single image example
    example_hex_data = """
// 'Gemini_Generated_Image_s7o7njs7o7njs7o7', 64x64px

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 

0x00, 0x00, 0x02, 0x60, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x20, 0x0d, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x03, 0x10, 0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x58, 0x19, 0xa0, 0x00, 0x00, 

0x00, 0x00, 0x02, 0x68, 0x15, 0x80, 0x00, 0x00, 0x00, 0x00, 0x02, 0x78, 0x1f, 0x80, 0x00, 0x00, 

0x00, 0x00, 0x03, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x1f, 0xa0, 0x00, 0x00, 

0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x27, 0xf0, 0x0f, 0xe0, 0x00, 0x00, 

0x00, 0x00, 0x07, 0xf0, 0x0f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xcf, 0xf3, 0xf0, 0x00, 0x00, 

0x00, 0x00, 0x0f, 0x80, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0xf0, 0x00, 0x00, 

0x00, 0x00, 0x3e, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x00, 0x00, 0x78, 0x00, 0x00, 

0x00, 0x00, 0x1c, 0x00, 0x02, 0x78, 0x00, 0x00, 0x00, 0x00, 0x5c, 0x00, 0x03, 0x78, 0x00, 0x00, 

0x00, 0x00, 0x7c, 0x00, 0x01, 0x78, 0x00, 0x00, 0x00, 0x00, 0x39, 0x01, 0x00, 0x78, 0x00, 0x00, 

0x00, 0x00, 0x3f, 0x41, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x84, 0x7c, 0x00, 0x00, 

0x00, 0x00, 0x3e, 0x00, 0xc4, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x81, 0xc6, 0x7c, 0x00, 0x00, 

0x00, 0x00, 0x3f, 0x83, 0x83, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x83, 0x83, 0xf8, 0x00, 0x00, 

0x00, 0x00, 0x1f, 0x8b, 0xb3, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfd, 0xff, 0xf0, 0x00, 0x00, 

0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x00, 

0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x60, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x06, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
"""
    
    # Multiple images example - add your hex data blocks here as a list
    # Each string in the list is one image's hex data
    # You can add as many images as you want
    IMAGES = [
        example_hex_data,  # First image
        # Add more images here by pasting hex data:
        # """
"""
// '// 'Gemini_Generated_Image_7ed2r7ed2r7ed2r7', 64x64px
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x02, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x24, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0xb2, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x02, 0xf2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xf0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0x45, 0xc8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x67, 0xca, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x3f, 0xc3, 0x40, 0x00, 0x00, 0x00, 0x00, 0x02, 0x3f, 0xe7, 0x40, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xff, 0xfe, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x05, 0xff, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x04, 0xe0, 0x0e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x05, 0xe0, 0x0f, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x0f, 0xe0, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x1f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xf8, 0x1f, 0xe8, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x1f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x1f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xe0, 0x0f, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x3f, 0xc0, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xbf, 0xff, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x3f, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x07, 0xfc, 0x00, 0x00, 
0x00, 0x00, 0x3e, 0x00, 0x03, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x03, 0xfc, 0x00, 0x00, 
0x00, 0x00, 0x3e, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x3e, 0x00, 0x02, 0x7c, 0x00, 0x00, 
0x00, 0x00, 0x3e, 0x40, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x50, 0x00, 0x78, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xc0, 0x02, 0x78, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xa0, 0x0a, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xf0, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf4, 0x2b, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xf2, 0x2b, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xfe, 0x9f, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x0f, 0xfe, 0xbf, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xff, 0xe0, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x06, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
""",

"""// 'Gemini_Generated_Image_ioijkkioijkkioij', 64x64px
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x26, 0x40, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x07, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x17, 0xc0, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x17, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0x80, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x01, 0x67, 0xf4, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xf4, 0x80, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0xfe, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x12, 0xe0, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0xe0, 0x0e, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x02, 0xe0, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0xf8, 0x1e, 0x40, 0x00, 0x00, 
0x00, 0x00, 0x03, 0xf8, 0x1e, 0x40, 0x00, 0x00, 0x00, 0x00, 0x0b, 0xf8, 0x1f, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x0b, 0xff, 0xff, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x33, 0xf8, 0x1f, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x37, 0xff, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x0f, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xc0, 0x07, 0xf4, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xbf, 0xfb, 0xf4, 0x00, 0x00, 
0x00, 0x00, 0x4f, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x00, 0x00, 0xfc, 0x00, 0x00, 
0x00, 0x00, 0x3e, 0x00, 0x01, 0x78, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x01, 0x3a, 0x00, 0x00, 
0x00, 0x00, 0x7c, 0x80, 0x00, 0x3a, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x80, 0x00, 0xbe, 0x00, 0x00, 
0x00, 0x00, 0x7c, 0x80, 0x01, 0x3e, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x80, 0x01, 0x3e, 0x00, 0x00, 
0x00, 0x00, 0x7f, 0x80, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x04, 0xfc, 0x00, 0x00, 
0x00, 0x00, 0x3f, 0x12, 0x04, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x44, 0x02, 0xfc, 0x00, 0x00, 
0x00, 0x00, 0x3f, 0xd6, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xb7, 0x63, 0xf8, 0x00, 0x00, 
0x00, 0x00, 0x1f, 0xf3, 0xe3, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfb, 0xef, 0xf0, 0x00, 0x00, 
0x00, 0x00, 0x07, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xff, 0xc0, 0x00, 0x00, 
0x00, 0x00, 0x01, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xfe, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x60, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x06, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x7f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00"""
    ]
    

    try:
        # Try to find display
        addresses_to_try = [0x3D, 0x3C]
        ports_to_try = [1, 0]
        device = None
        
        for port in ports_to_try:
            for addr in addresses_to_try:
                try:
                    print(f"Trying I2C port {port}, address 0x{addr:02X}...")
                    serial = i2c(port=port, address=addr)
                    device = ssd1309(serial)
                    print(f"âœ“ Display found at port {port}, address 0x{addr:02X}")
                    break
                except Exception as e:
                    print(f"  No display at port {port}, 0x{addr:02X}: {e}")
                    continue
            if device is not None:
                break
        
        if device is None:
            print("ERROR: Could not find display!")
            print("You can still test image conversion (without display)")
            print("=" * 40)
            # Parse and show image info even without display
            if hex_data_text:
                image_texts = split_multiple_images_from_text(hex_data_text)
            else:
                image_texts = IMAGES if len(IMAGES) > 0 else [example_hex_data]
            
            images = parse_multiple_images(image_texts)
            print(f"Created {len(images)} image(s)")
            for i, img in enumerate(images):
                print(f"  Image {i+1}: {img.size[0]}x{img.size[1]} pixels")
            print("Images created successfully (but no display to show them on)")
            exit(1)
        
        print(f"Display size: {device.width}x{device.height} pixels")
        print("Parsing hex data...")
        
        # Determine image source
        if hex_data_text:
            # Split file content into multiple images if separator exists
            image_texts = split_multiple_images_from_text(hex_data_text)
            print(f"Found {len(image_texts)} image(s) in file")
        else:
            # Use IMAGES list from script
            image_texts = IMAGES if len(IMAGES) > 0 else [example_hex_data]
            print(f"Using {len(image_texts)} image(s) from script")
        
        # Parse all images
        print("Converting hex data to images...")
        images = parse_multiple_images(image_texts)
        
        if len(images) == 0:
            print("ERROR: No valid images found!")
            exit(1)
        
        print(f"Successfully loaded {len(images)} image(s)")
        
        # Display images
        if args.single or len(images) == 1:
            # Single image mode
            print("Displaying single image on OLED...")
            display_image_on_oled(images[0], device)
            print("=" * 40)
            print("SUCCESS! Image displayed!")
            print("Press Ctrl+C to exit.")
            print("=" * 40)
            
            try:
                while True:
                    time.sleep(1)
            except KeyboardInterrupt:
                print("\nClearing display and exiting...")
                device.clear()
                print("Done!")
        else:
            # Animation mode - cycle through images
            print(f"Starting animation sequence ({len(images)} images, {args.rate}s per frame)...")
            print("=" * 40)
            print("Press Ctrl+C to exit.")
            print("=" * 40)
            
            try:
                frame_count = 0
                while True:
                    for i, img in enumerate(images):
                        display_image_on_oled(img, device)
                        frame_count += 1
                        if frame_count % len(images) == 0:
                            print(f"Cycle {frame_count // len(images)} complete", end='\r')
                        time.sleep(args.rate)
            except KeyboardInterrupt:
                print("\n\nClearing display and exiting...")
                device.clear()
                print(f"Displayed {frame_count} frames total")
                print("Done!")
    
    except Exception as e:
        print(f"ERROR: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()

